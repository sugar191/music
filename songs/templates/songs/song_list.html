{% extends 'base.html' %}
{% load static %}
{% load get_item %}
{% block title %}Êé°ÁÇπ{% endblock %}
{% block content %}
    <!-- Ê§úÁ¥¢„Éï„Ç©„Éº„É†Ôºà‰∏äÈÉ®Âõ∫ÂÆöÔºâ -->
    <!-- Ê§úÁ¥¢„Éï„Ç©„Éº„É†ÔºàGETÔºâ ‰∏ä„Å´Áã¨Á´ã„Åï„Åõ„Å¶ÂÆåÂÖ®„Å´Èñâ„Åò„Çã -->
    <div class="top-bar">
        <form method="get" action="{% url 'song_list' %}" style="display: flex; gap: 10px;">
            <input type="text" name="q" placeholder="Ê§úÁ¥¢ÔºàÊõ≤Âêç/„Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÔºâ" value="{{ query }}" style="flex: 1;">
            <button type="submit">Ê§úÁ¥¢</button>
        </form>
    </div>

    <!-- üéµ ÁÇπÊï∞‰øùÂ≠òÔºã„ÉÜ„Éº„Éñ„É´Ôºà‰∏≠Ôºâ -->
    <div class="table-area">
        <table>
            <tbody>
                {% for song in page_obj %}
                    <tr>
                        <td class="pc-cell">
                            <a href="{% url 'artist_songs' song.artist.id %}">{{ song.artist.name }}</a>
                        </td>
                        <td class="pc-cell">
                            <a href="https://www.youtube.com/results?search_query={{ song.artist.name|urlencode }}+{{ song.title|urlencode }}" target="_blank" rel="noopener noreferrer">{{ song.title }}</a>
                        </td>
                        <td class="pc-cell">
                            {% with form=rating_forms|get_item:song.id %}
                                <input type="number" name="{{ song.id }}-score" step="1" min="0" max="100" value="{{ form.initial.score|default_if_none:'' }}" data-song-id="{{ song.id }}" class="score-input">
                            {% endwith %}
                        </td>
                        <td class="count-cell pc-cell">
                            <input type="checkbox" class="cover-checkbox" data-song-id="{{ song.id }}" {% if song.is_cover %}checked{% endif %}>„Ç´„Éê„ÉºÊõ≤
                        </td>
                        <td class="mobile-cell">
                            <div><a href="https://www.youtube.com/results?search_query={{ song.artist.name|urlencode }}+{{ song.title|urlencode }}" target="_blank" rel="noopener noreferrer">{{ song.title }}</a></div>
                            <div><a href="{% url 'artist_songs' song.artist.id %}">{{ song.artist.name }}</a></div>
                        </td>
                        <td class="count-cell mobile-cell">
                            <div>
                                {% with form=rating_forms|get_item:song.id %}
                                    <input type="number" name="{{ song.id }}-score" step="1" min="0" max="100" value="{{ form.initial.score|default_if_none:'' }}" data-song-id="{{ song.id }}" class="score-input">
                                {% endwith %}
                            </div>
                            <div>
                                <input type="checkbox" class="cover-checkbox" data-song-id="{{ song.id }}" {% if song.is_cover %}checked{% endif %}>„Ç´„Éê„Éº
                            </div>
                        </td>
                    </tr>
                {% empty %}
                    <tr><td colspan="3">Ê•ΩÊõ≤„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div style="text-align: center;">
        {% if page_obj.has_previous %}
            <a href="?q={{ query }}&page={{ page_obj.previous_page_number }}">‚Üê Ââç„ÅÆ„Éö„Éº„Ç∏</a>
        {% endif %}

        <span>„Éö„Éº„Ç∏ {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
            <a href="?q={{ query }}&page={{ page_obj.next_page_number }}">Ê¨°„ÅÆ„Éö„Éº„Ç∏ ‚Üí</a>
        {% endif %}
    </div>
{% endblock %}
{% block extra_js %}
{{ block.super }}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const updateUrl = "{% url 'update_rating' %}";
            const coverUpdateUrl = "{% url 'update_cover' %}";  // ‚Üì view„ÅßÂÆöÁæ©‰∫àÂÆö
            const csrfToken = "{{ csrf_token }}";
            const inputs = document.querySelectorAll(".score-input");
            const checkboxes = document.querySelectorAll(".cover-checkbox");

            inputs.forEach(input => {
                input.addEventListener("change", function () {
                    const songId = this.dataset.songId;
                    const score = this.value;

                    showOverlay(); // Âá¶ÁêÜÈñãÂßã

                    fetch(updateUrl, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                            "X-CSRFToken": csrfToken,
                        },
                        body: `song_id=${songId}&score=${score}`,
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log(`‰øùÂ≠òÊàêÂäü: ${songId} = ${data.score}`);
                        } else {
                            alert(`„Ç®„É©„Éº: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        alert("‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü");
                        console.error(error);
                    })
                    .finally(() => {
                        hideOverlay(); // Âá¶ÁêÜÁµÇ‰∫Ü
                    });
                });
            });

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener("change", function () {
                    const songId = this.dataset.songId;
                    const isCover = this.checked;

                    fetch(coverUpdateUrl, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                            "X-CSRFToken": csrfToken,
                        },
                        body: `song_id=${songId}&is_cover=${isCover}`,
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) {
                            alert(`‰øùÂ≠ò„Ç®„É©„Éº: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        alert("ÈÄö‰ø°„Ç®„É©„Éº");
                        console.error(error);
                    });
                });
            });
        });
    </script>
{% endblock %}