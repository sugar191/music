{% extends 'base.html' %}
{% load static %}
{% load get_item %}
{% block title %}æ¡ç‚¹{% endblock %}
{% block content %}
    <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆä¸Šéƒ¨å›ºå®šï¼‰ -->
    <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆGETï¼‰ ä¸Šã«ç‹¬ç«‹ã•ã›ã¦å®Œå…¨ã«é–‰ã˜ã‚‹ -->
    <div class="top-bar">
        <form method="get" action="{% url 'song_list' %}" style="display: flex; gap: 10px;">
            <input type="text" name="q" placeholder="æ¤œç´¢ï¼ˆæ›²å/ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆï¼‰" value="{{ query }}" style="flex: 1;">
            <button type="submit">æ¤œç´¢</button>
        </form>
    </div>

    <!-- ğŸµ ç‚¹æ•°ä¿å­˜ï¼‹ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¸­ï¼‰ -->
    <div class="table-area">
        <table>
            <tbody>
                {% for song in page_obj %}
                    <tr>
                        <td>
                            <div><a href="https://www.youtube.com/results?search_query={{ song.artist.name|urlencode }}+{{ song.title|urlencode }}" target="_blank" rel="noopener noreferrer">{{ song.title }}</a></div>
                            <div><a href="{% url 'song_list' %}?q={{ song.artist.name }}">{{ song.artist.name }}</a></div>
                        </td>
                        <td>
                            {% with form=rating_forms|get_item:song.id %}
                                <input
                                    type="number"
                                    name="{{ song.id }}-score"
                                    step="1" min="0" max="100"
                                    value="{{ form.initial.score|default_if_none:'' }}"
                                    data-song-id="{{ song.id }}"
                                    class="score-input"
                                >
                            {% endwith %}
                        </td>
                    </tr>
                {% empty %}
                    <tr><td colspan="3">æ¥½æ›²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div style="text-align: center;">
        {% if page_obj.has_previous %}
            <a href="?q={{ query }}&page={{ page_obj.previous_page_number }}">â† å‰ã®ãƒšãƒ¼ã‚¸</a>
        {% endif %}

        <span>ãƒšãƒ¼ã‚¸ {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
            <a href="?q={{ query }}&page={{ page_obj.next_page_number }}">æ¬¡ã®ãƒšãƒ¼ã‚¸ â†’</a>
        {% endif %}
    </div>
{% endblock %}
{% block extra_js %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const updateUrl = "{% url 'update_rating' %}";
            const csrfToken = "{{ csrf_token }}";
            const inputs = document.querySelectorAll(".score-input");

            inputs.forEach(input => {
                input.addEventListener("change", function () {
                    const songId = this.dataset.songId;
                    const score = this.value;

                    fetch(updateUrl, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                            "X-CSRFToken": csrfToken,
                        },
                        body: `song_id=${songId}&score=${score}`,
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log(`ä¿å­˜æˆåŠŸ: ${songId} = ${data.score}`);
                        } else {
                            alert(`ã‚¨ãƒ©ãƒ¼: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        alert("ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                        console.error(error);
                    });
                });
            });
        });
    </script>
{% endblock %}